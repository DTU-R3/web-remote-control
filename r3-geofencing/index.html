<!DOCTYPE html>
<head>
    <meta name="viewport" id="vp" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width" />
    <meta charset="utf-8" />

    <link rel="stylesheet" href="https://api.mazemap.com/js/v2.0.9/mazemap.min.css">
    <script type='text/javascript' src='https://api.mazemap.com/js/v2.0.9/mazemap.min.js'></script>
	<script src="path/to/vanilla.js"></script>

    <style>
        body { margin:0px; padding:0px; width: 100vw; height:100vh; font-family: "Helvetica Neue",Helvetica,Arial,sans-serif; font-size: 14px; line-height: 1.42857143; }
        hr { border: 0; height: 1px; background-color: rgb(216, 216, 216); }
        #map {width: 50% !important;}
        #poidata {border-left: 1px solid rgb(230, 230, 230); width: 50%; position: absolute; right: 0px; top: 0px; height: 100%; padding: 10px; box-sizing: border-box; overflow: auto;}
    </style>
</head>
<body>
    <div id="map" class="mazemap"></div>
    <div id="controls" class="mapboxgl-ctrl-group">
	<div id="poidata"><h2>POI Data</h2><hr /><pre><code id="poi-data"></code></pre></div>
    </div>

    <script type="text/javascript">

        // Just the same way to initialize as always...
        var myMap = new Mazemap.Map({
            container: 'map',
            campuses: 88,
            center: {lng: 12.397615, lat: 55.731113},
            zoom: 17,
            zLevel: 1,
            scrollZoom: true,
            doubleClickZoom: false,
            touchZoomRotate: false
        });

        myMap.on('load', function(){

            myMap.on('click', onMapClick);

            // Initialize a Highlighter for POIs
            // Storing the object on the map just makes it easy to access for other things
            myMap.highlighter = new Mazemap.Highlighter( myMap, {
                showOutline: true, // optional
                showFill: true, // optional
                outlineColor: Mazemap.Util.Colors.MazeColors.MazeGreen, // optional
                fillColor: Mazemap.Util.Colors.MazeColors.MazeGreen  // optional
            } );

            // Trigger a manual 'click' on this lngLat just to highlight something initially
            //onMapClick({lngLat: {lng: 12.397615, lat: 55.731113}});


        });

        // define a global
        var mazeMarker;
		var h_light;

        function onMapClick(e){

            // un-highlight any already highlighted rooms
            //myMap.highlighter.clear();


            var lngLat = e.lngLat;
            var zLevel = myMap.zLevel;

            // Fetching via Data API
            // NB: Adding optional campusId parameter, makes lookup much faster, but can be omitted
            Mazemap.Data.getPoiAt(lngLat, zLevel).then( poi => {
                // Run custom highlight function
				console.log(poi);

                printPoiData(poi);
				POI_Filter(poi);
                // Just for visual effect, wait a bit before adding to map and zooming in
                setTimeout(function(){
                    placePoiMarker(poi);

                },1000);
            }).catch( function(){ return false; } );
        }

			function printPoiData(poi){
            var poiStr = JSON.stringify(poi, null, 2); // spacing level = 2
            document.getElementById('poi-data').innerHTML = poiStr;
			//post_data();
			get_data();
        }

		/*function post_data(){
			var r = new XMLHttpRequest();
			r.open("POST", "test.php", true);
			r.onreadystatechange = function () {
				if (r.readyState != 4 || r.status != 200){
					return;
				}
				alert("Success: " + r.responseText);
				};
			$data = {
				pois: {
					"points": [1, 2, 3]
					}
			};
			r.send(JSON.stringify($data));

		}*/

		function get_data(){
			var read = new XMLHttpRequest();
			read.open("GET", "data/test.json", true);
			read.onreadystatechange = function () {
				if (read.readyState != 4 || read.status != 200) {
					return;
				}
				alert("Success: " + read.responseText);
				//TODO: sanitise data, handle exceptions
				var data = JSON.parse(read.responseText);
				console.log(data);
			};
			read.send(null);
		}

        function placePoiMarker(poi){
            // Get a center point for the POI, because the data can return a polygon instead of just a point sometimes
            var lngLat = Mazemap.Util.getPoiLngLat(poi);

            var mazeMarker = new Mazemap.MazeMarker({
                color: '#ff00cc',
                innerCircle: true,
                innerCircleColor: '#FFF',
                size: 34,
                innerCircleScale: 0.5,
                zLevel: poi.properties.zLevel
            })
            .setLngLat(lngLat)
            .addTo(myMap);

            // If we have a polygon, use the default 'highlight' function to draw a marked outline around the POI.
            if(poi.geometry.type === "Polygon"){
            var h_light = myMap.highlighter.highlight(poi);
            }
            myMap.flyTo({center: lngLat, zoom: 19, speed: 0.5});

        }

		function POI_Filter(poi){
		var i;
		var n =1;
		var a;
		var c;
		var d;
		var temp = [];
		var tempArr = [];
		var lat_filt = [];
		var lng_filt = [];
		var poi_Filt=[];
		var length = [];
		var angle = 0 ;
		var R = 6371e3; //avrage radius of earth in meters
		var pi = Math.PI;

		temp = poi.geometry.coordinates[0];
		tempArr= temp[0];
		lng_filt[0] = tempArr[0];
		lat_filt[0] = tempArr[1];
		for (i=1; i< temp.length; i++){
		tempArr = temp[i];
		a = Math.sin((tempArr[1]*pi/180-lat_filt[n-1]*pi/180)/2) * Math.sin((tempArr[1]*pi/180-lat_filt[n-1]*pi/180)/2) +
		Math.cos(lat_filt[n-1]) * Math.cos(tempArr[1]) *
        Math.sin((tempArr[0]*pi/180-lng_filt[n-1]*pi/180)/2) * Math.sin((tempArr[0]*pi/180-lng_filt[n-1]*pi/180)/2);
		c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
		d = R*c;
		if (d > 0.25){
		lng_filt[n] = tempArr[0];
		lat_filt[n] = tempArr[1];
		length[n] = d;
		n++;
		}
		}
		temp = [];
		//console.log(lng_filt.join());
		//console.log(lat_filt.join());
		for (i=0; i < lng_filt.length; i++){
		temp[i] = [lng_filt[i],lat_filt[i]];
		}
		//console.log(temp);
		poi.geometry.coordinates[0] = temp;
		//console.log(poi.geometry.coordinates[0]);
		}


		/*var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
        Math.cos(φ1) * Math.cos(φ2) *
        Math.sin(Δλ/2) * Math.sin(Δλ/2);
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));*/

    </script>
</body>
